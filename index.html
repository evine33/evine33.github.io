<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Finanzas Pro - Gestor de Transacciones</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>

      
      body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  margin: 0;
  padding: 0;
  background: linear-gradient(to bottom right, #eef3fb, #dbe9f9);
  color: #333;
}

header {
  background: #0077ff;
  color: white;
  padding: 1rem 2rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

header h1 {
  margin: 0;
  font-size: 1.8rem;
}

main {
  padding: 2rem 1rem;
  max-width: 900px;
  margin: auto;
}

button {
  background: #0077ff;
  color: white;
  border: none;
  padding: 0.6rem 1.2rem;
  border-radius: 6px;
  font-size: 1rem;
  font-weight: 500;
  transition: background 0.3s;
  cursor: pointer;
  margin-top: 0.5rem;
}

button:hover {
  background: #005dcc;
}

.hidden {
  display: none;
}

.spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 3px solid rgba(255, 255, 255, 0.3);
  border-top-color: white;
  border-radius: 50%;
  animation: spin 1s ease-in-out infinite;
  margin-left: 0.5rem;
}

@keyframes spin {
  to { transform: rotate(360deg); }
}

#transactionsList {
  background: white;
  border-radius: 10px;
  padding: 1.5rem;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
  margin-top: 1.5rem;
}

.transaction-item {
  display: flex;
  justify-content: space-between;
  padding: 0.75rem 0;
  border-bottom: 1px solid #eee;
  font-size: 1rem;
}

.transaction-item:last-child {
  border-bottom: none;
}

.positive {
  color: #28a745;
  font-weight: bold;
}

.negative {
  color: #dc3545;
  font-weight: bold;
}

#formSection {
  margin-top: 1.5rem;
  background: white;
  padding: 1.5rem;
  border-radius: 10px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.08);
}

form h2 {
  margin-top: 0;
  color: #0077ff;
}

input, select {
  width: 100%;
  padding: 0.6rem;
  margin: 0.5rem 0 1rem;
  border: 1px solid #ccc;
  border-radius: 6px;
  font-size: 1rem;
}

input:focus, select:focus {
  outline: none;
  border-color: #0077ff;
  box-shadow: 0 0 0 2px rgba(0, 119, 255, 0.2);
}

  </style>
</head>
<body>
  <h1>üíº Finanzas Pro</h1>
  <div class="spinner" id="spinner"></div>

  <form onsubmit="guardarTransaccion(event)">
    <input type="hidden" id="edit-id">
    <input type="date" id="fecha" required>
<label for="tipo-monto">Tipo:</label>
<select id="tipo-monto" required>
  <option value="positivo">Ingreso</option>
  <option value="negativo">Gasto</option>
</select><br><br>
    <input type="number" id="monto" placeholder="Monto" required>
    
    <input type="text" id="categoria" placeholder="Categor√≠a" required>
    <input type="text" id="cantidad" placeholder="Cantidad (opcional)">
    <input type="file" id="imagen" accept="image/*">
    <button type="submit">üíæ Guardar Transacci√≥n</button>
  </form>

  <div class="filtros header-flex">
    <input type="text" id="buscador" placeholder="Buscar..." oninput="filtrarTransacciones()">
    <select id="filtro-categoria" onchange="filtrarTransacciones()">
      <option value="">Todas</option>
    </select>
    <input type="month" id="filtro-mes" onchange="filtrarTransacciones()">
  </div>

  <div class="transacciones" id="lista-transacciones"></div>

  <div class="modal" id="modal-img" onclick="cerrarModal()">
    <img id="img-ampliada" src="">
  </div>

  <script src="https://unpkg.com/dropbox/dist/Dropbox-sdk.min.js"></script>
<script>
  // JavaScript completo para Finanzas Pro
const APP_KEY = "k5t6sterc4j91oq";
const REDIRECT_URI = "https://evine33.github.io/";
let dbx;
let transactions = [];

const spinner = document.getElementById("spinner");
const form = document.querySelector("form");
const filtros = document.querySelector(".filtros");
const transacciones = document.querySelector(".transacciones");

form.style.transition = "all 0.4s ease";
form.style.opacity = 0;
form.style.maxHeight = "0";
form.style.overflow = "hidden";

filtros.style.display = "none";
transacciones.style.display = "none";

const toggleFormBtn = document.createElement("button");
toggleFormBtn.textContent = "+ Nueva Transacci√≥n";
toggleFormBtn.style.display = "none";
toggleFormBtn.className = "toggle-btn";
toggleFormBtn.onclick = () => {
  const isHidden = form.style.maxHeight === "0px" || form.style.maxHeight === "0";
  if (isHidden) {
    form.style.maxHeight = "800px";
    form.style.opacity = 1;
    toggleFormBtn.textContent = "‚ûñ Ocultar formulario";
  } else {
    form.style.maxHeight = "0";
    form.style.opacity = 0;
    toggleFormBtn.textContent = "+ Nueva Transacci√≥n";
  }
};
document.body.insertBefore(toggleFormBtn, form);

function showSpinner(state) {
  spinner.style.display = state ? "block" : "none";
}

function iniciarSesion() {
  const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${APP_KEY}&response_type=token&redirect_uri=${REDIRECT_URI}`;
  window.location.href = authUrl;
}

window.onload = async () => {
  const connectBtn = document.createElement("button");
  connectBtn.textContent = "üîê Conectar con Dropbox";
  connectBtn.onclick = iniciarSesion;
  document.body.insertBefore(connectBtn, toggleFormBtn);

  const params = new URLSearchParams(window.location.hash.substring(1));
  const token = params.get("access_token");
  if (token) {
    dbx = new Dropbox.Dropbox({ accessToken: token });
    connectBtn.remove();

    toggleFormBtn.style.display = "block";
    filtros.style.display = "flex";
    transacciones.style.display = "block";

    await cargarTransacciones();
  }
};

async function cargarTransacciones() {
  showSpinner(true);
  try {
    const archivo = await dbx.filesDownload({ path: "/transactions.json" });
    const texto = await archivo.result.fileBlob.text();
    const json = JSON.parse(texto);
    transactions = json.transactions || [];
  } catch (e) {
    transactions = [];
  }
  window.transactions_123 = transactions;
  showSpinner(false);
  mostrarTransacciones();
}

function mostrarTransacciones(filtradas = null) {
  const lista = document.getElementById("lista-transacciones");
  lista.innerHTML = "";

  const datos = filtradas || transactions;
  if (datos.length === 0) {
    lista.innerHTML = '<p class="empty">No hay transacciones</p>';
    return;
  }

  const categorias = [...new Set(transactions.map(t => t.category))];
  const select = document.getElementById("filtro-categoria");
  select.innerHTML = '<option value="">Todas</option>' + categorias.map(c => `<option>${c}</option>`).join("");

  datos.forEach(async t => {
    const card = document.createElement("div");
    card.className = "card";
    const color = t.amount < 0 ? "#ffdddd" : "#ddffdd";
    const signo = t.amount < 0 ? "üîª" : "üî∫";
    card.style.background = color;
    card.innerHTML = `
      <strong>${t.date}</strong> - <b>${signo} ${t.amount}</b> (${t.category})<br>
      ${t.cantidad || ""}<div class="acciones">
        <button onclick="editar(${t.id})">‚úèÔ∏è Editar</button>
        <button onclick="eliminar(${t.id})">üóëÔ∏è Eliminar</button>
      </div>`;

    try {
      const imgArchivo = await dbx.filesDownload({ path: `/imagenes/tx-${t.id}.txt` });
      const base64 = await imgArchivo.result.fileBlob.text();
      const img = document.createElement("img");
      img.src = `data:image/jpeg;base64,${base64}`;
      img.onclick = () => ampliarImagen(img.src);
      card.appendChild(img);
    } catch {}

    lista.appendChild(card);
  });
}

function ampliarImagen(src) {
  document.getElementById("img-ampliada").src = src;
  document.getElementById("modal-img").classList.add("active");
}
function cerrarModal() {
  document.getElementById("modal-img").classList.remove("active");
}

function editar(id) {
  const t = transactions.find(tx => tx.id === id);
  if (!t) return;
  document.getElementById("edit-id").value = t.id;
  document.getElementById("fecha").value = t.date;
  document.getElementById("monto").value = Math.abs(t.amount);
  document.getElementById("tipo-monto").value = t.amount >= 0 ? "positivo" : "negativo";
  document.getElementById("categoria").value = t.category;
  document.getElementById("cantidad").value = t.cantidad || "";
  form.style.maxHeight = "800px";
  form.style.opacity = 1;
  toggleFormBtn.textContent = "‚ûñ Ocultar formulario";
}
function cancelarEdicion() {
  document.querySelector("form").reset();
  document.getElementById("edit-id").value = "";
  form.style.maxHeight = "0";
  form.style.opacity = 0;
  toggleFormBtn.textContent = "+ Nueva Transacci√≥n";
}

async function guardarTransaccion(event) {
  event.preventDefault();
  if (!dbx) return alert("Debes iniciar sesi√≥n con Dropbox");

  const id = document.getElementById("edit-id").value;
  const fecha = document.getElementById("fecha").value;
  const monto = parseFloat(document.getElementById("monto").value);
  const tipo = document.getElementById("tipo-monto").value;
  const amount = tipo === "negativo" ? -Math.abs(monto) : Math.abs(monto);
  const categoria = document.getElementById("categoria").value.trim();
  const cantidad = document.getElementById("cantidad").value.trim();
  const archivo = document.getElementById("imagen").files[0];

  let transId = id ? parseInt(id) : (transactions.at(-1)?.id || 0) + 1;

  if (id) {
    const tx = transactions.find(t => t.id === transId);
    Object.assign(tx, { date: fecha, amount, category: categoria, cantidad });
  } else {
    transactions.push({ id: transId, date: fecha, amount, category: categoria, cantidad });
  }

  await guardarEnDropbox();

  if (archivo) {
    const reader = new FileReader();
    reader.onload = async function () {
      const img = new Image();
      img.onload = async function () {
        const canvas = document.createElement("canvas");
        let scale = Math.min(600 / img.width, 600 / img.height);
        canvas.width = img.width * scale;
        canvas.height = img.height * scale;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        const base64 = canvas.toDataURL("image/jpeg", 0.75).split(',')[1];

        await dbx.filesUpload({
          path: `/imagenes/tx-${transId}.txt`,
          contents: base64,
          mode: { '.tag': 'overwrite' }
        });

        mostrarTransacciones();
      };
      img.src = reader.result;
    };
    reader.readAsDataURL(archivo);
  } else {
    mostrarTransacciones();
  }

  cancelarEdicion();
}

async function guardarEnDropbox() {
  try {
    await dbx.filesUpload({
      path: "/transactions.json",
      contents: JSON.stringify({ transactions }, null, 2),
      mode: { ".tag": "overwrite" }
    });

    const contenidoJS = "window.transactions_123 = " + JSON.stringify(transactions, null, 2) + ";";
    await dbx.filesUpload({
      path: "/transactions.js",
      contents: contenidoJS,
      mode: { ".tag": "overwrite" }
    });

    window.transactions_123 = transactions;
  } catch (error) {
    alert("Error al guardar en Dropbox: " + (error?.error?.error_summary || error.message));
  }
}

async function eliminar(id) {
  if (!confirm("¬øEliminar esta transacci√≥n?")) return;
  transactions = transactions.filter(t => t.id !== id);
  await guardarEnDropbox();

  try {
    await dbx.filesDeleteV2({ path: `/imagenes/tx-${id}.txt` });
  } catch (e) {
    console.warn("Imagen ya eliminada o no encontrada");
  }

  mostrarTransacciones();
}

function filtrarTransacciones() {
  const texto = document.getElementById("buscador").value.toLowerCase();
  const categoria = document.getElementById("filtro-categoria").value;
  const mes = document.getElementById("filtro-mes").value;

  const resultado = transactions.filter(t => {
    return (
      (!texto || t.category.toLowerCase().includes(texto) || t.date.includes(texto) || (t.cantidad || "").toLowerCase().includes(texto)) &&
      (!categoria || t.category === categoria) &&
      (!mes || t.date.startsWith(mes))
    );
  });

  mostrarTransacciones(resultado);
}

</script>
</body>
</html>
